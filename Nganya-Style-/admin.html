<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Driver Applications</title>

<style>
body { font-family: Poppins, sans-serif; padding: 20px; background: #f4f4f4; }
h2 { margin-top: 30px; }
.card { background: #bd9808ff;  color: #fff;padding: 20px; border-radius: 10px; margin: 20px 0; }
button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
.approve { background: #28a745; color: #fff;border-radius: 10px; padding: 20px;}
.reject { background: #dc2410ff; color: #fff;border-radius: 10px; padding: 15px; }
.list-item { 
    padding: 10px; 
    border-bottom: 1px solid #ddd; 
}

/* Remove lines for approved drivers */
#approvedList .list-item {
    border-bottom: none;
}

/* Remove lines for rejected drivers */
#rejectedList .list-item {
    border-bottom: none;
}

.section {
    margin-bottom: 40px;
    margin-top: 20px;
}

footer {
  background: #222;
  color: white;
  text-align: center;
  padding: 5px;
  margin-top: 30px;
  font-size: 1rem;
  margin-bottom: -25px;
  margin-left: -28px;
  margin-right: -28px;
}
</style>
</head>

<body>
<h1>Admin Dashboard – Nganya</h1>

<div class="section">
<div class="card">
    <h2>Pending Applications</h2>
    <div id="pendingList"></div>
</div>
<br><br>
<div class="approve">
    <h2>Approved Drivers</h2>
    <div id="approvedList"></div>
</div>
<br><br>
<div class="reject">
    <h2>Rejected Applications</h2>
    <div id="rejectedList"></div>
</div>
</div>
<script>
const API = "https://nganya-project.onrender.com/api";

// LOAD ALL DRIVERS (PENDING / APPROVED / REJECTED)
async function loadApplications(){
    try {
        const res = await fetch(`${API}/drivers/all`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        console.log('Loaded drivers:', data); // Debug log

        let pending = "";
        let approved = "";
        let rejected = "";

        data.forEach(app => {
            let listing = `
                <div class="list-item">
                    <b>${app.name}</b> – ${app.vehicle || '---'} – ${app.route || '---'}<br>
                    Phone: ${app.phone} — Capacity: ${app.capacity || '---'}<br>
            `;

            if(app.status === "pending"){
                listing += `
                    <button class="approve" onclick="approve('${app._id}')">Approve</button>
                    <button class="reject" onclick="rejectApp('${app._id}')">Reject</button>
                `;
                pending += listing + "</div>";
            }
            else if(app.status === "approved"){
                approved += listing + "</div>";
            }
            else if(app.status === "rejected"){
                listing += `<br><i>Reason: ${app.rejectReason || "No reason provided"}</i>`;
                rejected += listing + "</div>";
            }
        });

        document.getElementById("pendingList").innerHTML = pending || "<i>No pending applications</i>";
        document.getElementById("approvedList").innerHTML = approved || "<i>No approved drivers</i>";
        document.getElementById("rejectedList").innerHTML = rejected || "<i>No rejected applications</i>";
    } catch (error) {
        console.error('Error loading applications:', error);
        alert('Failed to load applications: ' + error.message);
    }
}

// APPROVE DRIVER
async function approve(id){
    try {
        const response = await fetch(`${API}/drivers/approve`, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ driverId: id })
        });
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        console.log('Approve result:', result); // Debug log
        
        if (result.success) {
            await loadApplications();
        } else {
            alert('Approve failed: ' + result.message);
        }
    } catch (error) {
        console.error('Error approving driver:', error);
        alert('Failed to approve driver: ' + error.message);
    }
}

// REJECT DRIVER - IMPROVED WITH ERROR HANDLING
async function rejectApp(id){
    const reason = prompt("Reason for rejection:");
    
    // If user cancels the prompt, do nothing
    if (reason === null) return;
    
    try {
        console.log('Rejecting driver:', id, 'Reason:', reason); // Debug log
        
        const response = await fetch(`${API}/drivers/reject`, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ 
                driverId: id, 
                reason: reason || "No reason provided" 
            })
        });

        console.log('Response status:', response.status); // Debug log
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Reject result:', result); // Debug log
        
        if (result.success) {
            console.log('Driver rejected successfully');
            await loadApplications();
        } else {
            alert('Reject failed: ' + result.message);
        }
    } catch (error) {
        console.error('Error rejecting driver:', error);
        alert('Failed to reject driver: ' + error.message);
    }
}

// INITIAL LOAD
loadApplications();
</script>

</body>
<footer>
    <p>© 2025 Nganya Project</p>
</footer>
</html>
